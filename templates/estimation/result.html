{% extends "estimation/base_estimation.html" %}

{% block estimation_title %}Votre estimation personnalis√©e{% endblock %}
{% block estimation_subtitle %}Analyse compl√®te de votre projet d'investissement locatif{% endblock %}

{% block estimation_content %}
<div class="space-y-8">
    
    <!-- Header avec score de confiance -->
    <div class="text-center bg-gradient-to-r from-gold-50 to-mocha-50 border border-gold-200 rounded-xl p-6">
        <div class="flex justify-center items-center space-x-4 mb-4">
            <div class="text-4xl font-bold text-gold-600">{{ "%.1f"|format(estimation.confidence_score * 100) }}%</div>
            <div class="text-left">
                <div class="text-lg font-semibold text-mocha-900">Fiabilit√© de l'estimation</div>
                <div class="text-sm text-mocha-600">Bas√©e sur {{ estimation.data_sources|length }} sources de donn√©es</div>
            </div>
        </div>
        <div class="text-sm text-mocha-700">
            Estimation g√©n√©r√©e le {{ estimation.created_at.strftime('%d/%m/%Y √† %H:%M') }}
        </div>
    </div>

    <!-- M√©triques principales -->
    <div class="grid md:grid-cols-4 gap-6">
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center shadow-sm">
            <div class="text-2xl font-bold text-green-600 mb-2">{{ "%.1f"|format(estimation.gross_yield) }}%</div>
            <div class="text-sm text-mocha-600">Rendement brut</div>
            <div class="text-xs text-mocha-500 mt-1">
                {% if estimation.gross_yield >= 6 %}Excellent{% elif estimation.gross_yield >= 4 %}Bon{% else %}Moyen{% endif %}
            </div>
        </div>
        
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center shadow-sm">
            <div class="text-2xl font-bold text-blue-600 mb-2">{{ "%.1f"|format(estimation.net_yield) }}%</div>
            <div class="text-sm text-mocha-600">Rendement net</div>
            <div class="text-xs text-mocha-500 mt-1">Charges d√©duites</div>
        </div>
        
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center shadow-sm">
            <div class="text-2xl font-bold {% if estimation.monthly_cashflow >= 0 %}text-green-600{% else %}text-red-600{% endif %} mb-2">
                {{ "{:+,}".format(estimation.monthly_cashflow|int).replace(',', ' ') }}‚Ç¨
            </div>
            <div class="text-sm text-mocha-600">Cash-flow mensuel</div>
            <div class="text-xs text-mocha-500 mt-1">
                {% if estimation.monthly_cashflow > 200 %}Tr√®s positif{% elif estimation.monthly_cashflow >= 0 %}√âquilibr√©{% else %}D√©ficitaire{% endif %}
            </div>
        </div>
        
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center shadow-sm">
            <div class="text-2xl font-bold text-purple-600 mb-2">{{ estimation.payback_years }} ans</div>
            <div class="text-sm text-mocha-600">Retour sur investissement</div>
            <div class="text-xs text-mocha-500 mt-1">Dur√©e amortissement</div>
        </div>
    </div>

    <!-- D√©tails financiers -->
    <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-mocha-900 mb-4">üí∞ D√©tail financier</h3>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-mocha-800 mb-3">Revenus mensuels</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Loyer estim√©</span>
                        <span class="font-medium">{{ "{:,}".format(estimation.estimated_rent|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                    {% if estimation.additional_income > 0 %}
                    <div class="flex justify-between">
                        <span>Revenus annexes</span>
                        <span class="font-medium">{{ "{:,}".format(estimation.additional_income|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between font-semibold border-t pt-2">
                        <span>Total revenus</span>
                        <span>{{ "{:,}".format((estimation.estimated_rent + estimation.additional_income)|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h4 class="font-medium text-mocha-800 mb-3">Charges mensuelles</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Mensualit√© cr√©dit</span>
                        <span class="font-medium">{{ "{:,}".format(estimation.monthly_loan_payment|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Charges & gestion</span>
                        <span class="font-medium">{{ "{:,}".format(estimation.monthly_expenses|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Assurances & taxes</span>
                        <span class="font-medium">{{ "{:,}".format(estimation.monthly_taxes|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                    <div class="flex justify-between font-semibold border-t pt-2">
                        <span>Total charges</span>
                        <span>{{ "{:,}".format((estimation.monthly_loan_payment + estimation.monthly_expenses + estimation.monthly_taxes)|int).replace(',', ' ') }}‚Ç¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analyse de march√© -->
    {% if estimation.market_analysis %}
    <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-mocha-900 mb-4">üìä Analyse de march√©</h3>
        <div class="grid md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-xl font-bold text-blue-600">{{ estimation.market_analysis.average_rent_per_m2 }}‚Ç¨/m¬≤</div>
                <div class="text-sm text-blue-700">Prix march√© local</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-xl font-bold text-green-600 capitalize">{{ estimation.market_analysis.demand_level }}</div>
                <div class="text-sm text-green-700">Niveau de demande</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="text-xl font-bold text-purple-600 capitalize">{{ estimation.market_analysis.market_trend }}</div>
                <div class="text-sm text-purple-700">Tendance march√©</div>
            </div>
        </div>
        
        {% if estimation.market_analysis.insights %}
        <div class="mt-4 p-4 bg-mocha-50 rounded-lg">
            <h4 class="font-medium text-mocha-800 mb-2">üí° Recommandations march√©</h4>
            <ul class="text-sm text-mocha-700 space-y-1">
                {% for insight in estimation.market_analysis.insights %}
                <li>‚Ä¢ {{ insight }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Potentiel de r√©novation AskElena -->
    {% if estimation.renovation_potential %}
    <div class="bg-gradient-to-r from-gold-50 to-mocha-50 border border-gold-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-mocha-900 mb-4">üèóÔ∏è Potentiel de valorisation AskElena</h3>
        
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-mocha-800 mb-3">Sc√©nario actuel</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Loyer estim√©</span>
                        <span>{{ "{:,}".format(estimation.estimated_rent|int).replace(',', ' ') }}‚Ç¨/mois</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Rendement net</span>
                        <span>{{ "%.1f"|format(estimation.net_yield) }}%</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h4 class="font-medium text-mocha-800 mb-3">Apr√®s r√©novation AskElena</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Loyer potentiel</span>
                        <span class="font-semibold text-gold-600">{{ "{:,}".format(estimation.renovation_potential.optimized_rent|int).replace(',', ' ') }}‚Ç¨/mois</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Rendement net (50/50)</span>
                        <span class="font-semibold text-gold-600">{{ "%.1f"|format(estimation.renovation_potential.partnership_yield) }}%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-white rounded-lg border border-gold-200">
            <h4 class="font-medium text-mocha-800 mb-2">ü§ù Notre partenariat 50/50</h4>
            <div class="text-sm text-mocha-700 space-y-1">
                <p>‚Ä¢ <strong>Pr√©financement:</strong> AskElena avance {{ "{:,}".format(estimation.renovation_potential.estimated_cost|int).replace(',', ' ') }}‚Ç¨ de travaux</p>
                <p>‚Ä¢ <strong>Partage:</strong> 50% des revenus pour vous apr√®s remboursement des travaux</p>
                <p>‚Ä¢ <strong>Gain mensuel:</strong> +{{ "{:,}".format((estimation.renovation_potential.optimized_rent * 0.5 - estimation.estimated_rent)|int).replace(',', ' ') }}‚Ç¨/mois √† terme</p>
                <p>‚Ä¢ <strong>ROI:</strong> {{ "%.0f"|format(estimation.renovation_potential.partnership_roi) }}% annuel sur votre apport</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Risques et recommandations -->
    <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-mocha-900 mb-4">‚ö†Ô∏è Points d'attention</h3>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-medium text-red-700 mb-3">Risques identifi√©s</h4>
                <ul class="text-sm text-mocha-700 space-y-2">
                    {% for risk in estimation.risks %}
                    <li class="flex items-start space-x-2">
                        <span class="text-red-500 mt-1">‚Ä¢</span>
                        <span>{{ risk }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <div>
                <h4 class="font-medium text-green-700 mb-3">Recommandations</h4>
                <ul class="text-sm text-mocha-700 space-y-2">
                    {% for recommendation in estimation.recommendations %}
                    <li class="flex items-start space-x-2">
                        <span class="text-green-500 mt-1">‚Ä¢</span>
                        <span>{{ recommendation }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-gradient-to-r from-mocha-900 to-mocha-800 text-white rounded-xl p-8 text-center">
        <h3 class="text-xl font-semibold mb-4">üéØ Prochaines √©tapes</h3>
        <p class="mb-6 text-mocha-100">
            Nos experts AskElena vont analyser votre projet en d√©tail et vous recontacter sous 48h 
            avec une proposition personnalis√©e.
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{{ url_for('estimation.download_pdf', estimation_id=estimation.id) }}" 
               class="bg-gold-500 hover:bg-gold-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                üìÑ T√©l√©charger le rapport PDF
            </a>
            
            <a href="tel:+33123456789" 
               class="bg-white text-mocha-900 hover:bg-mocha-50 px-6 py-3 rounded-lg font-semibold transition-colors">
                üìû Nous appeler maintenant
            </a>
            
            <a href="{{ url_for('index') }}" 
               class="border border-white text-white hover:bg-white hover:text-mocha-900 px-6 py-3 rounded-lg font-semibold transition-colors">
                üè† Retour √† l'accueil
            </a>
        </div>
    </div>

    <!-- Nouvelle estimation -->
    <div class="text-center">
        <a href="{{ url_for('estimation.start') }}" 
           class="inline-flex items-center text-gold-600 hover:text-gold-800 font-medium">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Faire une nouvelle estimation
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des m√©triques au chargement
    const metrics = document.querySelectorAll('[class*="text-2xl font-bold"]');
    
    metrics.forEach((metric, index) => {
        metric.style.opacity = '0';
        metric.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            metric.style.transition = 'all 0.6s ease-out';
            metric.style.opacity = '1';
            metric.style.transform = 'translateY(0)';
        }, index * 200);
    });
    
    // Tracking pour analytics
    if (typeof gtag !== 'undefined') {
        gtag('event', 'estimation_completed', {
            'event_category': 'engagement',
            'event_label': 'estimation_wizard',
            'value': 1
        });
    }
    
    // Partage social (optionnel)
    function shareEstimation() {
        if (navigator.share) {
            navigator.share({
                title: 'Mon estimation locative AskElena',
                text: 'D√©couvrez le potentiel de votre investissement immobilier',
                url: window.location.href
            });
        }
    }
    
    // Impression du rapport
    function printReport() {
        window.print();
    }
    
    // Exposer les fonctions globalement si n√©cessaire
    window.shareEstimation = shareEstimation;
    window.printReport = printReport;
});
</script>
{% endblock %}
